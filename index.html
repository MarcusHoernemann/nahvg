<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NahVG Mitglieder-Infosystem</title>
    <meta name="theme-color" content="#003a66">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --nahvg-blue: #003a66; --nahvg-yellow: #ffcc00; --success-green: #28a745; --alert-red: #d93025; --text-dark: #333; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--nahvg-blue); margin: 0; padding: 0; color: var(--text-dark); min-height: 100vh; }
        header { background-color: var(--nahvg-blue); color: white; padding: 45px 15px 25px 15px; text-align: center; border-bottom: 4px solid var(--nahvg-yellow); position: relative; }
        .container { padding: 15px; max-width: 1400px; margin: auto; }
        .app-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 15px auto; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .stats-bar { background-color: var(--nahvg-yellow); color: var(--nahvg-blue); padding: 12px; border-radius: 8px; margin: 10px 0; font-weight: bold; text-align: center; border: 2px solid var(--nahvg-blue); }
        
        #results { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        @media (min-width: 768px) { #results { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1100px) { #results { grid-template-columns: repeat(3, 1fr); } }

        .member-card { background: white; border-radius: 12px; border-left: 6px solid var(--nahvg-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; }
        .m-body { padding: 18px; flex-grow: 1; }
        .m-title { font-weight: bold; color: var(--nahvg-blue); font-size: 1.2rem; }
        .contact-links { background-color: #eceff1; padding: 14px; border-top: 1.5px solid #d1d9e0; display: flex; justify-content: space-around; gap: 5px; }
        .contact-links a, .contact-links span { color: var(--nahvg-blue); font-weight: bold; text-decoration: none; cursor: pointer; font-size: 0.85rem; text-align: center; flex: 1; }
        #fileInput { display: none; }
        #toast { visibility: hidden; background: var(--success-green); color: white; text-align: center; padding: 16px; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); border-radius: 50px; z-index: 2000; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<header>
    <h1 onclick="debugColumns()" style="cursor:help">NahVG</h1>
    <h2 id="ogNameDisplay">Lade System...</h2>
</header>

<div class="container">
    <div id="setupScreen" class="app-card">
        <h3 style="text-align: center;">Excel-Datei importieren</h3>
        <p style="text-align: center; color: red; font-size: 0.8rem;">Hinweis: Es wird nur die Spalte "Mobil" eingelesen.</p>
        <label for="fileInput" style="background: var(--nahvg-yellow); color: var(--nahvg-blue); padding: 18px; display: block; text-align: center; border-radius: 10px; font-weight: bold; cursor: pointer;">üìÇ DATEI AUSW√ÑHLEN</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
    </div>

    <div id="appArea" style="display:none;">
        <div class="app-card">
            <input type="text" id="searchInput" placeholder="Suchen..." onkeyup="filterData()">
            <select id="filterArbeitgeber" onchange="filterData()"></select>
            <div id="statsDisplay" class="stats-bar">üë• <span id="statsText">0</span> Mitglieder</div>
            <button onclick="resetApp()" style="background:none; border:none; color:var(--nahvg-blue); text-decoration:underline; width:100%; cursor:pointer; margin-top:10px;">Andere Datei laden</button>
        </div>
        <div id="results"></div>
    </div>
</div>

<div id="toast">‚úÖ Kopiert!</div>

<script>
    let members = [];
    let rawColumns = [];

    window.onload = function() {
        const savedData = localStorage.getItem('nahvg_data');
        const savedOG = localStorage.getItem('nahvg_og');
        if (savedData) {
            members = JSON.parse(savedData);
            document.getElementById('ogNameDisplay').innerText = savedOG;
            showApp();
        }
        document.getElementById('fileInput').addEventListener('change', processFile);
    };

    function processFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {defval: ""});

                if (json.length > 0) rawColumns = Object.keys(json[0]);

                members = json.map(row => {
                    const keys = Object.keys(row);
                    
                    const getVal = (fragments, exclude = []) => {
                        const foundKey = keys.find(k => {
                            const cleanK = k.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                            const matches = fragments.some(f => cleanK.includes(f.toLowerCase()));
                            const isExcluded = exclude.some(ex => cleanK.includes(ex.toLowerCase()));
                            return matches && !isExcluded;
                        });
                        return foundKey ? String(row[foundKey]).trim() : "";
                    };

                    return {
                        vorname: getVal(['vorname']),
                        nachname: getVal(['nachname', 'name', 'mitglied']),
                        betrieb: getVal(['arbeitgeber', 'betrieb']),
                        mail: getVal(['email', 'mail']),
                        // PRIORIT√ÑT: Nur Mobil/Handy, Telefon aktiv ausschlie√üen
                        tel: getVal(['mobil', 'handy'], ['telefon', 'festnetz']), 
                        str: getVal(['strasse', 'stra√üe']),
                        plz: getVal(['plz']),
                        ort: getVal(['ort'])
                    };
                }).filter(m => m.nachname !== "");

                localStorage.setItem('nahvg_data', JSON.stringify(members));
                localStorage.setItem('nahvg_og', file.name.replace(/\.[^/.]+$/, ""));
                location.reload(); 
            } catch (err) {
                alert("Fehler: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function debugColumns() {
        if (rawColumns.length > 0) {
            alert("Gefundene Spalten in deiner Datei:\n\n" + rawColumns.join("\n"));
        } else {
            alert("Lade erst eine Datei hoch, um die Spalten zu pr√ºfen.");
        }
    }

    function showApp() {
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('appArea').style.display = 'block';
        const ags = [...new Set(members.map(m => m.betrieb))].filter(a => a).sort();
        const sel = document.getElementById('filterArbeitgeber');
        sel.innerHTML = '<option value="">Alle Betriebe</option>' + ags.map(a => `<option value="${a}">${a}</option>`).join('');
        filterData();
    }

    function filterData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const agFilter = document.getElementById('filterArbeitgeber').value;
        const container = document.getElementById('results');
        const filtered = members.filter(m => {
            const matchesSearch = (m.vorname + m.nachname + m.betrieb + m.ort).toLowerCase().includes(query);
            return matchesSearch && (!agFilter || m.betrieb === agFilter);
        });

        document.getElementById('statsText').innerText = filtered.length;
        container.innerHTML = filtered.map(m => `
            <div class="member-card">
                <div class="m-body">
                    <div class="m-title">${m.vorname} ${m.nachname}</div>
                    <div style="font-size:0.9rem; margin: 5px 0;">üè¢ <b>${m.betrieb || '-'}</b></div>
                    <div style="font-size:0.85rem; color: #666;">üè† ${m.str}, ${m.plz} ${m.ort}</div>
                </div>
                <div class="contact-links">
                    ${m.tel ? `<a href="tel:${m.tel.replace(/\s+/g, '')}">üì± ${m.tel}</a>` : '<span style="color:red">üì± k.A.</span>'}
                    ${m.mail ? `<span onclick="copyMail('${m.mail}')">‚úâÔ∏è Mail</span>` : '<span>‚úâÔ∏è k.A.</span>'}
                </div>
            </div>
        `).join('');
    }

    function copyMail(email) {
        navigator.clipboard.writeText(email);
        const t = document.getElementById("toast");
        t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    function resetApp() {
        if(confirm("Daten l√∂schen?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
