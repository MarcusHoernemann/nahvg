<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NahVG Mitglieder-Infosystem</title>
    <meta name="theme-color" content="#003a66">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --nahvg-blue: #003a66; --nahvg-yellow: #ffcc00; --success-green: #28a745; --text-dark: #333; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--nahvg-blue); margin: 0; padding: 0; color: var(--text-dark); min-height: 100vh; }
        header { background-color: var(--nahvg-blue); color: white; padding: 45px 15px 25px 15px; text-align: center; border-bottom: 4px solid var(--nahvg-yellow); }
        .container { padding: 15px; max-width: 1400px; margin: auto; }
        
        .app-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 15px auto; }
        
        .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stats-badge { background: var(--nahvg-yellow); color: var(--nahvg-blue); padding: 8px 12px; border-radius: 6px; font-weight: bold; border: 2px solid var(--nahvg-blue); }
        .bulk-btn { background: var(--nahvg-blue); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }

        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        #results { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        @media (min-width: 768px) { #results { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1100px) { #results { grid-template-columns: repeat(3, 1fr); } }

        .member-card { background: white; border-radius: 12px; border-left: 6px solid var(--nahvg-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
        .m-body { padding: 18px; flex-grow: 1; }
        .m-title { font-weight: bold; color: var(--nahvg-blue); font-size: 1.2rem; margin-bottom: 5px; }
        
        .contact-links { background-color: #eceff1; padding: 14px; border-top: 1.5px solid #d1d9e0; display: flex; justify-content: space-around; }
        .contact-links a, .contact-links span { color: var(--nahvg-blue); font-weight: bold; text-decoration: none; cursor: pointer; font-size: 0.85rem; }
        
        #fileInput { display: none; }
        #toast { visibility: hidden; background: var(--success-green); color: white; text-align: center; padding: 16px; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); border-radius: 50px; z-index: 2000; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<header>
    <h1>NahVG</h1>
    <h2 id="ogNameDisplay">Daten-Import</h2>
</header>

<div class="container">
    <div id="setupScreen" class="app-card">
        <h3 style="text-align: center;">Excel-Datei laden</h3>
        <label for="fileInput" style="background: var(--nahvg-yellow); color: var(--nahvg-blue); padding: 18px; display: block; text-align: center; border-radius: 10px; font-weight: bold; cursor: pointer;">üìÇ DATEI AUSW√ÑHLEN</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
    </div>

    <div id="appArea" style="display:none;">
        <div class="app-card">
            <div class="info-header">
                <div class="stats-badge">üë• <span id="statsText">0</span></div>
                <button class="bulk-btn" onclick="sendBulkEmail()">üìß Sammelemail</button>
            </div>
            <input type="text" id="searchInput" placeholder="Suchen..." onkeyup="filterData()">
            <select id="filterArbeitgeber" onchange="filterData()"></select>
            <button onclick="resetApp()" style="background:none; border:none; color:var(--nahvg-blue); text-decoration:underline; width:100%; cursor:pointer; margin-top:10px; font-size:0.75rem;">Andere Datei hochladen</button>
        </div>
        <div id="results"></div>
    </div>
</div>

<div id="toast">‚úÖ Kopiert!</div>

<script>
    let members = [];
    let currentFiltered = [];

    window.onload = function() {
        const savedData = localStorage.getItem('nahvg_data');
        const savedOG = localStorage.getItem('nahvg_og');
        if (savedData) {
            members = JSON.parse(savedData);
            document.getElementById('ogNameDisplay').innerText = savedOG;
            showApp();
        }
        document.getElementById('fileInput').addEventListener('change', processFile);
    };

    function processFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});

                members = json.map(row => {
                    const find = (names, exclude = []) => {
                        const key = Object.keys(row).find(k => {
                            const kl = k.toLowerCase().trim();
                            return names.some(n => kl.includes(n)) && !exclude.some(ex => kl.includes(ex));
                        });
                        return key ? String(row[key]).trim() : "";
                    };

                    return {
                        vorn: find(['vorname']),
                        nachn: find(['nachname', 'name']),
                        firma: find(['arbeitgeber', 'betrieb']),
                        mail: find(['email', 'mail']),
                        mobil: find(['mobil', 'handy'], ['telefon', 'festnetz']), // IGNORIERT TELEFON
                        str: find(['strasse', 'stra√üe']),
                        plz: find(['plz']),
                        ort: find(['ort'])
                    };
                }).filter(m => m.nachn !== "");

                localStorage.setItem('nahvg_data', JSON.stringify(members));
                localStorage.setItem('nahvg_og', file.name.replace(/\.[^/.]+$/, ""));
                location.reload(); 
            } catch (err) {
                alert("Fehler beim Import.");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function showApp() {
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('appArea').style.display = 'block';
        const ags = [...new Set(members.map(m => m.firma))].filter(a => a).sort();
        const sel = document.getElementById('filterArbeitgeber');
        sel.innerHTML = '<option value="">Alle Betriebe</option>' + ags.map(a => `<option value="${a}">${a}</option>`).join('');
        filterData();
    }

    function filterData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const ag = document.getElementById('filterArbeitgeber').value;
        
        currentFiltered = members.filter(m => {
            const match = (m.vorn + " " + m.nachn + " " + m.firma + " " + m.ort).toLowerCase().includes(query);
            return match && (!ag || m.firma === ag);
        });

        document.getElementById('statsText').innerText = currentFiltered.length;
        document.getElementById('results').innerHTML = currentFiltered.map(m => `
            <div class="member-card">
                <div class="m-body">
                    <div class="m-title">${m.vorn} ${m.nachn}</div>
                    <div>üè¢ <b>${m.firma || '-'}</b></div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">üè† ${m.str}, ${m.plz} ${m.ort}</div>
                </div>
                <div class="contact-links">
                    ${m.mobil ? `<a href="tel:${m.mobil.replace(/\D/g, '')}">üì± ${m.mobil}</a>` : '<span style="color:#d93025">üì± k.A.</span>'}
                    ${m.mail ? `<span onclick="copyMail('${m.mail}')">‚úâÔ∏è Kopieren</span>` : '<span>‚úâÔ∏è k.A.</span>'}
                </div>
            </div>
        `).join('');
    }

    function sendBulkEmail() {
        const mails = currentFiltered.map(m => m.mail).filter(m => m.includes('@'));
        if (mails.length > 0) window.location.href = "mailto:?bcc=" + mails.join(',');
    }

    function copyMail(m) {
        navigator.clipboard.writeText(m);
        const t = document.getElementById("toast");
        t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    function resetApp() {
        if(confirm("Daten l√∂schen?")) { localStorage.clear(); location.reload(); }
    }
</script>
</body>
</html>
